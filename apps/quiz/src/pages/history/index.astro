---
import Layout from "../../layouts/Layout.astro";
import { supabase } from "../../lib/supabase";

const { data: quizzes, error } = await supabase
  .from("quizzes")
  .select("id, date, questions")
  .order("date", { ascending: false });

const formatDate = (dateStr: string) => {
  return new Date(dateStr).toLocaleDateString("en-US", {
    year: "numeric",
    month: "short",
    day: "numeric",
  });
};

const getDifficultyBreakdown = (questions: { difficulty: string }[]) => {
  const counts = { easy: 0, medium: 0, hard: 0 };
  questions.forEach((q) => {
    if (q.difficulty in counts) {
      counts[q.difficulty as keyof typeof counts]++;
    }
  });
  return counts;
};

const getCategories = (questions: { category: string }[]) => {
  const categories = new Set(questions.map((q) => q.category));
  return Array.from(categories).slice(0, 3);
};
---

<Layout
  title="Quiz Archive"
  description="Explore our archive of daily trivia quizzes. Hundreds of past quizzes covering general knowledge, history, science, geography, and more. Play any day you missed."
  canonicalUrl="https://quiz.cosmic.garden/history"
>
  <h1 class="text-3xl font-bold text-quiz-text mb-2">Quiz Archive</h1>
  <p class="text-quiz-text-muted mb-8">Browse and play past daily quizzes</p>

  {
    error || !quizzes || quizzes.length === 0 ? (
      <div class="text-center py-12">
        <p class="text-quiz-text-muted">No quizzes available yet.</p>
      </div>
    ) : (
      <div class="space-y-3">
        {quizzes.map((quiz) => {
          const breakdown = getDifficultyBreakdown(quiz.questions);
          const categories = getCategories(quiz.questions);
          return (
            <a
              href={`/history/${quiz.date}`}
              class="block p-4 bg-quiz-surface border border-quiz-border rounded-lg hover:border-quiz-accent transition-colors"
            >
              <div class="flex items-center justify-between mb-2">
                <span class="font-medium text-quiz-text">
                  {formatDate(quiz.date)}
                </span>
                <div class="flex items-center gap-2 text-xs">
                  <span class="text-quiz-easy">{breakdown.easy} easy</span>
                  <span class="text-quiz-medium">
                    {breakdown.medium} medium
                  </span>
                  <span class="text-quiz-hard">{breakdown.hard} hard</span>
                </div>
              </div>
              <div class="flex flex-wrap gap-2">
                {categories.map((cat) => (
                  <span class="px-2 py-1 text-xs bg-quiz-border rounded text-quiz-text-muted">
                    {cat}
                  </span>
                ))}
              </div>
            </a>
          );
        })}
      </div>
    )
  }
</Layout>
